<!DOCTYPE html>
<html>
<head>
    <title>问卷设置</title>
    {% include 'system/common/header.html' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='system/admin/css/other/user.css') }}"/>
    <style>
        /* Dropdown 样式 */
        .layui-btn-group {
            position: relative;
            display: inline-block;
            vertical-align: middle;
        }
        
        .dropdown-toggle {
            border-left: 1px solid rgba(255,255,255,0.2);
            margin-left: -1px;
            padding: 0 8px;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 1000;
            min-width: 120px;
            padding: 5px 0;
            margin: 2px 0 0;
            background-color: #fff;
            border: 1px solid #e6e6e6;
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.12);
        }
        
        .dropdown-menu li {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .dropdown-menu li a {
            display: block;
            padding: 8px 15px;
            color: #333;
            text-decoration: none;
            white-space: nowrap;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .dropdown-menu li a:hover {
            background-color: #f2f2f2;
            color: #333;
        }
        
        .dropdown-menu li a i {
            margin-right: 5px;
            font-size: 12px;
        }
        
        /* 确保下拉菜单在表格中正确显示 */
        /* 只对操作列应用overflow: visible样式 */
        .layui-table-body tr td:last-child .layui-table-cell {
            overflow: visible !important;
        }
        
        /* 按钮组样式调整 */
        .layui-btn-group .pear-btn {
            float: left;
            border-radius: 0;
        }
        
        .layui-btn-group .pear-btn:first-child {
            border-top-left-radius: 2px;
            border-bottom-left-radius: 2px;
        }
        
        .layui-btn-group .pear-btn:last-child {
            border-top-right-radius: 2px;
            border-bottom-right-radius: 2px;
        }
    </style>
</head>
<body class="pear-container">
{# 查询表单 #}
<div class="layui-card">
    <div class="layui-card-body">
        <form class="layui-form" action="" lay-filter="user-query-form">
            <div class="layui-form-item">
                <label class="layui-form-label">问卷名称</label>
                <div class="layui-input-inline">
                    <input type="text" name="questionnaire_name" placeholder="" class="layui-input">
                </div>
                <button class="pear-btn pear-btn-md pear-btn-primary" lay-submit lay-filter="questionnaire-query">
                    <i class="layui-icon layui-icon-search"></i>
                    查询
                </button>
                <button type="reset" class="pear-btn pear-btn-md">
                    <i class="layui-icon layui-icon-refresh"></i>
                    重置
                </button>
            </div>
        </form>
    </div>
</div>
<div class="user-left user-collasped">
    <div class="layui-card">
        <div class="layui-card-body">
            <div class="button button-primary user-group" user-group=""> 全 部 问 卷</div>
            <div class="button button-default user-group" user-group="-1"> 默 认 分 组</div>
            <div style="overflow: auto">
                <ul id="dept-tree" class="dept-tree" data-id="0"></ul>
            </div>
        </div>
    </div>
</div>
{# 用户表格 #}
<div class="user-main user-collasped">
    <div class="layui-card">
        <div class="layui-card-body">
            <table id="questionnaire-table" lay-filter="questionnaire-table"></table>
        </div>
    </div>
</div>
</body>
{# 表格操作 #}
<script type="text/html" id="questionnaire-toolbar">
    {% if authorize("system:questionnaire:add") %}
        <button class="pear-btn pear-btn-primary pear-btn-md" lay-event="add">
            <i class="pear-icon pear-icon-add"></i>
            新增
        </button>
    {% endif %}
    <button class="pear-btn pear-btn-md" lay-event="collasped">
        <i class="pear-icon pear-icon-modular"></i>
        高级
    </button>
</script>

{# 问卷修改操作 #}
<script type="text/html" id="questionnaire-bar">
    {% raw %}
        {{# if(d.status == 0){ }}
            <a href="javascript:;" lay-event="design"><i class="pear-icon"></i> 设计</a>
            <span>|</span>
            <a href="javascript:;" lay-event="publish"><i class="pear-icon"></i> 发布</a>
            {% endraw %}
            {% if authorize("system:questionnaire:edit") %}
            <span>|</span>
            <a href="javascript:;" lay-event="edit"><i class="pear-icon"></i> 编辑</a>
            {% endif %}
            {% if authorize("system:questionnaire:remove") %}
                {% raw %}
                {{# if(d.response_count == 0){ }}
                <span>|</span>
                <a href="javascript:;" lay-event="remove"><i class="pear-icon"></i> 删除</a>
                {{# } }}
                {% endraw %}
            {% endif %}
            {% raw %}
        {{# } else if(d.status == 1){ }}
            <!-- 发布状态：主要操作 + 下拉菜单 -->
            <a href="javascript:;" lay-event="preview"><i class="pear-icon"></i> 预览</a>
            <span>|</span>
            <a href="javascript:;" lay-event="share"><i class="pear-icon"></i> 分享</a>
            <span>|</span>
            <a href="javascript:;" lay-event="responses"><i class="pear-icon"></i> 记录</a>
            {% endraw %}
            {% if authorize("system:questionnaire:edit") %}
            <span>|</span>
            <a href="javascript:;" lay-event="edit"><i class="pear-icon"></i> 编辑</a>
            {% endif %}
            {% if authorize("system:questionnaire:remove") %}
            {% raw %}
            {{# if(d.response_count == 0){ }}
            <span>|</span>
            <a href="javascript:;" lay-event="remove"><i class="pear-icon"></i> 删除</a>
            {{# } }}
            {% endraw %}
            {% endif %}
            {% raw %}
        {{# } else { }}
            <!-- 其他状态：只显示下拉菜单 -->
            <a href="javascript:;" lay-event="responses"><i class="pear-icon"></i> 记录</a>
            {% endraw %}
            {% if authorize("system:questionnaire:edit") %}
            {% raw %}
            <a href="javascript:;" lay-event="edit"><i class="pear-icon"></i> 编辑</a>
            {% endraw %}
            {% endif %}
            {% if authorize("system:questionnaire:remove") %}
            {% raw %}
            {{# if(d.response_count == 0){ }}
            <a href="javascript:;" lay-event="remove"><i class="pear-icon"></i> 删除</a>
            {{# } }}
            {% endraw %}
            {% endif %}
            {% raw %}
        {{# } }}
    {% endraw %}
</script>

{% raw %}
<script type="text/html" id="questionnaire-status">
    {{# if(d.status == 0){ }}
        <span class="layui-badge layui-bg-gray">草稿</span>
    {{# } else if(d.status == 1){ }}
        <span class="layui-badge layui-bg-green">发布</span>
    {{# } else if(d.status == 2){ }}
        <span class="layui-badge layui-bg-orange">停止</span>
    {{# } else if(d.status == 3){ }}
        <span class="layui-badge layui-bg-blue">归档</span>
    {{# } }}
</script>

<script type="text/html" id="questionnaire-anonymous">
    {{# if(d.allow_anonymous == 1){ }}
        <span class="layui-badge layui-bg-green">是</span>
    {{# } else { }}
        <span class="layui-badge layui-bg-gray">否</span>
    {{# } }}
</script>

<script type="text/html" id="questionnaire-login">
    {{# if(d.require_login == 1){ }}
        <span class="layui-badge layui-bg-orange">是</span>
    {{# } else { }}
        <span class="layui-badge layui-bg-gray">否</span>
    {{# } }}
</script>

<script type="text/html" id="questionnaire-startTime">
    {{# if(d.start_time){ }}
        {{layui.util.toDateString(d.start_time, "yyyy-MM-dd")}}
    {{# } else { }}
        <span class="layui-badge layui-bg-gray">未设置</span>
    {{# } }}
</script>

<script type="text/html" id="questionnaire-endTime">
    {{# if(d.end_time){ }}
        {{layui.util.toDateString(d.end_time, "yyyy-MM-dd")}}
    {{# } else { }}
        <span class="layui-badge layui-bg-gray">未设置</span>
    {{# } }}
</script>

<script type="text/html" id="questionnaire-createTime">
    {{layui.util.toDateString(d.create_at, "yyyy-MM-dd")}}
</script>
{% endraw %}

{% include 'system/common/footer.html' %}

<script>
    layui.use(['table', 'dtree', 'form', 'jquery', 'popup', 'common'], function () {
        let table = layui.table
        let form = layui.form
        let $ = layui.jquery
        let dtree = layui.dtree
        let popup = layui.popup
        let common = layui.common
        let MODULE_PATH = "{{ url_for('system.questionnaire.main') }}"
        
        // 表格数据
        let cols = [
            [
                {title: 'ID', field: 'id', align: 'center', width: 40, fixed: 'left'},
                {title: '问卷标题', field: 'title', align: 'center', width: 200, fixed: 'left'},
                {title: '问卷描述', field: 'description', align: 'center', width: 180},
                {title: '问卷类型', field: 'type_text', align: 'center', width: 100},
                {title: '状态', field: 'status', align: 'center', templet: '#questionnaire-status', width: 100},
                {title: '开始时间', field: 'start_time', templet: '#questionnaire-startTime', align: 'center', width: 120},
                {title: '结束时间', field: 'end_time', templet: '#questionnaire-endTime', align: 'center', width: 120},
                // {title: '最大回答数', field: 'max_responses', align: 'center', width: 100},
                // {title: '允许匿名', field: 'allow_anonymous', align: 'center', templet: '#questionnaire-anonymous', width: 100},
                // {title: '需要登录', field: 'require_login', align: 'center', templet: '#questionnaire-login', width: 100},
                {title: '创建时间', field: 'create_at', templet: '#questionnaire-createTime', align: 'center', width: 120},
                {title: '操作', toolbar: '#questionnaire-bar', align: 'center', width: 200, fixed: 'right'}
            ]
        ]

        // 渲染表格数据
        table.render({
            elem: '#questionnaire-table',
            url: MODULE_PATH + 'data',
            page: true,
            cols: cols,
            skin: 'line',
            height: 'full-148',
            toolbar: '#questionnaire-toolbar', /*工具栏*/
            text: {none: '暂无人员信息'},
            defaultToolbar: [{layEvent: 'refresh', icon: 'layui-icon-refresh'}, 'filter', 'print', 'exports'] /*默认工具栏*/
        })

        // 公司部门树状图菜单
        dtree.render({
            elem: '#dept-tree',
            method: 'get',
            url: '/system/dept/tree',
            dataFormat: 'list',
            line: true,
            skin: 'laySimple',
            icon: '-1',
            response: {treeId: 'id', parentId: 'parent_id', title: 'dept_name'},
        })

        // 菜单栏渲染
        dtree.on('node(\'dept-tree\')', function (obj) {
            let field = form.val('questionnaire-query-form') /*用户账号查询*/
            field.deptId = obj.param.nodeId
            window.refresh(field)
        })

        //
        $('.user-group').click(function () {
            let group = $(this).attr('user-group')
            let field = form.val('questionnaire-query-form')
            if (group === '-1') {
                field.deptId = group
                $(this).removeClass('button-default')
                $(this).prev().removeClass('button-primary')
                $(this).prev().addClass('button-default')
                $(this).addClass('button-primary')
            } else {
                field.deptId = group
                $(this).removeClass('button-default')
                $(this).next().removeClass('button-primary')
                $(this).next().addClass('button-default')
                $(this).addClass('button-primary')
            }
            window.refresh(field)
        })

        table.on('tool(questionnaire-table)', function (obj) {
            if (obj.event === 'remove') {
                window.remove(obj)
            } else if (obj.event === 'edit') {
                window.edit(obj)
            } else if (obj.event === 'design') {
                window.design(obj)
            } else if (obj.event === 'publish') {
                window.publish(obj)
            } else if (obj.event === 'preview') {
                window.preview(obj)
            } else if (obj.event === 'share') {
                window.share(obj)
            } else if (obj.event === 'responses') {
                window.responses(obj);
            } else if (obj.event === 'dropdown') {
                // 处理下拉菜单点击
                let $dropdown = $(obj.tr).find('.dropdown-menu');
                let $toggle = $(obj.tr).find('.dropdown-toggle');
                
                // 关闭其他已打开的下拉菜单
                $('.dropdown-menu').not($dropdown).hide();
                
                // 切换当前下拉菜单
                $dropdown.toggle();
                
                // 阻止事件冒泡
                event.stopPropagation();
            }
        })

        // 下拉菜单项点击事件

        // 点击其他地方关闭下拉菜单
        $(document).on('click', function() {
            $('.dropdown-menu').hide();
        });

        table.on('toolbar(questionnaire-table)', function (obj) {
            if (obj.event === 'add') {
                window.add()
            } else if (obj.event === 'refresh') {
                window.refresh()
            } else if (obj.event === 'batchRemove') {
                window.batchRemove(obj)
            } else if (obj.event === 'collasped') {
                $('.user-left').toggleClass('user-collasped')
                $('.user-main').toggleClass('user-collasped')
                table.resize()
            }
        })

        form.on('submit(questionnaire-query)', function (data) {
            window.refresh(data.field)
            return false
        })

        form.on('switch(questionnaire-enable)', function (obj) {
            let operate
            if (obj.elem.checked) {
                operate = 'enable'
            } else {
                operate = 'disable'
            }
            let loading = layer.load()
            $.ajax({
                url: '{{ url_for('system.questionnaire.main') }}' + operate,
                data: JSON.stringify({questionnaireId: this.value}),
                dataType: 'json',
                contentType: 'application/json',
                type: 'put',
                success: function (result) {
                    layer.close(loading)
                    if (result.success) {
                        popup.success(result.msg)
                    } else {
                        popup.failure(result.msg)
                    }
                }
            })
        })

        window.add = function () {
            layer.open({
                type: 2,
                title: '新增',
                shade: 0.1,
                area: ['550px', '550px'],
                content: MODULE_PATH + 'add'
            })
        }

        window.edit = function (obj) {
            layer.open({
                type: 2,
                title: '修改',
                shade: 0.1,
                area: ['550px', '500px'],
                content: MODULE_PATH + 'edit/' + obj.data['id']
            })
        }

        window.design = function (obj) {
            layer.open({
                type: 2,
                title: '问卷设计',
                shade: 0.1,
                area: ['100%', '100%'],
                content: MODULE_PATH + 'design/' + obj.data['id']
            })
        }

        window.publish = function (obj) {
            layer.confirm('确定要发布该问卷吗？发布后问卷将对外开放，用户可以填写。', {icon: 3, title: '发布确认'}, function (index) {
                layer.close(index)
                let loading = layer.load()
                $.ajax({
                    url: MODULE_PATH + 'publish/' + obj.data['id'],
                    dataType: 'json',
                    type: 'post',
                    success: function (result) {
                        layer.close(loading)
                        if (result.success) {
                            popup.success(result.msg, function () {
                                window.refresh() // 刷新表格数据
                            })
                        } else {
                            popup.failure(result.msg)
                        }
                    },
                    error: function () {
                        layer.close(loading)
                        popup.failure('发布失败，请稍后重试')
                    }
                })
            })
        }

        window.preview = function (obj) {
            // 在新窗口中打开问卷预览页面
            layer.open({
                type: 2,
                title: '问卷预览 - ' + obj.data['title'],
                shade: 0.1,
                area: ['90%', '90%'],
                content: MODULE_PATH + 'preview/' + obj.data['id']
            })
        }

        window.share = function (obj) {
            // 分享问卷
            let shareUrl = window.location.origin + '/system/questionnaire/fill/' + obj.data['id'];
            let shareContent = `
                <div style="padding: 20px;">
                    <h3 style="margin-bottom: 15px;">分享问卷：${obj.data['title']}</h3>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">分享链接：</label>
                        <div style="display: flex; align-items: center;">
                            <input type="text" id="shareUrl" value="${shareUrl}" readonly 
                                   style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                            <button type="button" id="copyUrlBtn" class="pear-btn pear-btn-primary pear-btn-sm">
                                <i class="layui-icon layui-icon-file"></i> 复制链接
                            </button>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <div style="margin-bottom: 10px; font-weight: bold;">扫描二维码填写：</div>
                        <div id="qrcode" style="display: inline-block;"></div>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background-color: #f5f5f5; border-radius: 4px; font-size: 12px; color: #666;">
                        <i class="layui-icon layui-icon-tips"></i> 
                        用户可通过此链接或二维码访问并填写问卷
                    </div>
                </div>
            `;
            
            layer.open({
                type: 1,
                title: '分享问卷',
                area: ['500px', '450px'],
                content: shareContent,
                success: function(layero, index) {
                    // 生成二维码 - 优先使用本地API
                    generateQRCode(shareUrl, 'qrcode');
                    
                    // 复制链接功能
                    document.getElementById('copyUrlBtn').onclick = function() {
                        let shareUrlInput = document.getElementById('shareUrl');
                        shareUrlInput.select();
                        shareUrlInput.setSelectionRange(0, 99999);
                        
                        try {
                            document.execCommand('copy');
                            layer.msg('链接已复制到剪贴板', {icon: 1, time: 2000});
                        } catch (err) {
                            // 如果复制失败，尝试使用现代API
                            if (navigator.clipboard) {
                                navigator.clipboard.writeText(shareUrl).then(function() {
                                    layer.msg('链接已复制到剪贴板', {icon: 1, time: 2000});
                                }).catch(function() {
                                    layer.msg('复制失败，请手动复制链接', {icon: 2, time: 2000});
                                });
                            } else {
                                layer.msg('复制失败，请手动复制链接', {icon: 2, time: 2000});
                            }
                        }
                    };
                }
            });
        }

        window.remove = function (obj) {
            layer.confirm('确定要删除该用户', {icon: 3, title: '提示'}, function (index) {
                layer.close(index)
                let loading = layer.load()
                $.ajax({
                    url: MODULE_PATH + 'remove/' + obj.data['id'],
                    dataType: 'json',
                    type: 'delete',
                    success: function (result) {
                        layer.close(loading)
                        if (result.success) {
                            popup.success(result.msg, function () {
                                obj.del()
                            })
                        } else {
                            popup.failure(result.msg)
                        }
                    }
                })
            })
        }


        window.refresh = function (param) {
            table.reload('questionnaire-table', {where: param})
        }

        window.responses = function (obj) {
            // 打开问卷填写记录查看页面
            parent.layui.tab.addTabOnlyByElem("content", {
                id: 'questionnaire-records-' + obj.data.id,
                title: '问卷填写记录 - ' + obj.data['title'],
                url:  MODULE_PATH + 'responses/' + obj.data['id'],
                close: true
            });
        }

        // 二维码生成函数
        window.generateQRCode = function(url, containerId) {
            // 优先使用前端QRCode库
            if (typeof QRCode !== 'undefined') {
                try {
                    new QRCode(document.getElementById(containerId), {
                        text: url,
                        width: 150,
                        height: 150,
                        colorDark: "#000000",
                        colorLight: "#ffffff"
                    });
                    return;
                } catch (e) {
                    console.warn('前端QRCode库生成失败，尝试使用后端API:', e);
                }
            }
            
            // 使用后端API生成二维码
            $.ajax({
                url: '/api/qrcode/generate',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({url: url}),
                success: function(result) {
                    if (result.success && result.data && result.data.qrcode) {
                        document.getElementById(containerId).innerHTML = 
                            '<img src="' + result.data.qrcode + '" alt="二维码" style="border: 1px solid #ddd; width: 150px; height: 150px;">';
                    } else {
                        // 最后的fallback：使用第三方API
                        document.getElementById(containerId).innerHTML = 
                            '<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=' + 
                            encodeURIComponent(url) + '" alt="二维码" style="border: 1px solid #ddd;">';
                    }
                },
                error: function() {
                    console.warn('后端二维码API调用失败，使用第三方API');
                    // 最后的fallback：使用第三方API
                    document.getElementById(containerId).innerHTML = 
                        '<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=' + 
                        encodeURIComponent(url) + '" alt="二维码" style="border: 1px solid #ddd;">';
                }
            });
        }
    })
</script>
</html>