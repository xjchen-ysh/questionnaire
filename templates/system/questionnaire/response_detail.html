<!DOCTYPE html>
<html>
<head>
    <title>问卷填写记录详情</title>
    {% include 'system/common/header.html' %}
    <style>
        /* 确保layui栅格系统正常工作 */
        .layui-row:after, .layui-row:before {
            content: "";
            display: block;
            clear: both;
        }
        .layui-col-md6 {
            position: relative;
            display: block;
            box-sizing: border-box;
            float: left;
            width: 50%;
        }
        .layui-col-space15 > [class*="layui-col-"] {
            padding: 0 7.5px;
        }
    </style>
</head>
<body class="pear-container">
<div class="layui-fluid" style="padding: 10px;">
<div class="layui-card">
    <div class="layui-card-header">
        <span class="layui-icon layui-icon-file"></span>
        问卷填写记录详情
    </div>
    <div class="layui-card-body">
        <div class="layui-row layui-col-space15">
            <div class="layui-col-md8">
                <div class="layui-card">
                    <div class="layui-card-header">
                        <i class="layui-icon layui-icon-user"></i> 填写信息
                    </div>
                    <div class="layui-card-body">
                        <!-- 第一行：问卷标题 + 记录ID -->
                        <div class="layui-row layui-col-space15">
                            <div class="layui-col-md6">
                                <div class="info-item">
                                    <label class="info-label">问卷标题</label>
                                    <div class="info-value">{{ response.questionnaire.title if response.questionnaire else '未知' }}</div>
                                </div>
                            </div>
                            <div class="layui-col-md6">
                                <div class="info-item">
                                    <label class="info-label">记录ID</label>
                                    <div class="info-value">#{{ response.id }}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 第二行：姓名 + 手机号 -->
                        <div class="layui-row layui-col-space15">
                            <div class="layui-col-md6">
                                <div class="info-item">
                                    <label class="info-label">姓名</label>
                                    <div class="info-value">
                                        {% if response.name %}
                                            <span class="user-name">{{ response.name }}</span>
                                        {% else %}
                                            <span class="text-muted">未填写</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="layui-col-md6">
                                <div class="info-item">
                                    <label class="info-label">手机号</label>
                                    <div class="info-value">
                                        {% if response.phone %}
                                            <span class="phone-number">{{ response.phone }}</span>
                                        {% else %}
                                            <span class="text-muted">未填写</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 第三行：提交时间 + IP地址 -->
                        <div class="layui-row layui-col-space15">
                            <div class="layui-col-md6">
                                <div class="info-item">
                                    <label class="info-label">提交时间</label>
                                    <div class="info-value">
                                        {% if response.submit_time %}
                                            <span class="submit-time">{{ response.submit_time.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                                        {% else %}
                                            <span class="text-muted">未提交</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="layui-col-md6">
                                <div class="info-item">
                                    <label class="info-label">IP地址</label>
                                    <div class="info-value">
                                        <span class="ip-address">{{ response.ip_address or '未记录' }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <style>
                .info-item {
                    margin-bottom: 20px;
                    padding: 12px 15px;
                    background: #fafafa;
                    border-radius: 6px;
                    border-left: 3px solid #1E9FFF;
                }
                .info-label {
                    display: block;
                    font-weight: 600;
                    color: #666;
                    font-size: 12px;
                    margin-bottom: 6px;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                .info-value {
                    font-size: 14px;
                    color: #333;
                    line-height: 1.4;
                    font-weight: 500;
                }
                .user-name {
                    color: #1E9FFF;
                    font-weight: 600;
                }
                .phone-number {
                    color: #5FB878;
                    font-family: 'Courier New', monospace;
                    font-weight: 600;
                }
                .submit-time {
                    color: #FF5722;
                    font-family: 'Courier New', monospace;
                    font-weight: 500;
                }
                .ip-address {
                    color: #999;
                    font-family: 'Courier New', monospace;
                    font-size: 13px;
                }
                .text-muted {
                    color: #999;
                    font-style: italic;
                }
                
                /* 响应式优化 */
                @media (max-width: 768px) {
                    .layui-col-md6 {
                        width: 100% !important;
                        margin-bottom: 10px;
                    }
                    .info-item {
                        margin-bottom: 15px;
                    }
                }
                </style>

                <!-- 问卷答案详情 -->
                {% if questions %}
                <div class="layui-card">
                    <div class="layui-card-header">
                        <span class="layui-icon layui-icon-form"></span>
                        问卷答案详情
                    </div>
                    <div class="layui-card-body">
                        {% for question in questions %}
                        {% set answer = answer_dict.get(question.id) %}
                        <div class="layui-card" style="margin-bottom: 15px;">
                            <div class="layui-card-header" style="background-color: #f8f8f8;">
                                <strong>{{ loop.index }}. {{ question.title }}</strong>
                                <span class="layui-badge layui-bg-gray" style="margin-left: 10px;">
                                    {% if question.question_type == 'single_choice' %}单选题
                                    {% elif question.question_type == 'multiple_choice' %}多选题
                                    {% elif question.question_type == 'text' %}文本题
                                    {% elif question.question_type == 'textarea' %}长文本题
                                    {% elif question.question_type == 'number' %}数字题
                                    {% elif question.question_type == 'date' %}日期题
                                    {% elif question.question_type == 'time' %}时间题
                                    {% elif question.question_type == 'datetime' %}日期时间题
                                    {% elif question.question_type == 'email' %}邮箱题
                                    {% elif question.question_type == 'phone' %}电话题
                                    {% elif question.question_type == 'url' %}网址题
                                    {% elif question.question_type == 'file' %}文件上传题
                                    {% elif question.question_type == 'rating' %}评分题
                                    {% elif question.question_type == 'matrix' %}矩阵题
                                    {% else %}{{ question.question_type }}
                                    {% endif %}
                                </span>
                                {% if question.required %}
                                <span class="layui-badge layui-bg-red" style="margin-left: 5px;">必填</span>
                                {% endif %}
                            </div>
                            <div class="layui-card-body">
                                {% if question.description %}
                                <div class="layui-text" style="color: #666; margin-bottom: 10px;">
                                    {{ question.description }}
                                </div>
                                {% endif %}
                                
                                <!-- 显示选择题的选项 -->
                                {% if question.question_type in ['single_choice', 'multiple_choice'] and question.options %}
                                <div style="margin-bottom: 15px;">
                                    <h5 style="color: #666; margin-bottom: 8px;">可选项：</h5>
                                    <div style="background-color: #fafafa; padding: 10px; border-radius: 4px;">
                                        {% for option in question.options %}
                                         <div style="margin-bottom: 5px; color: #333;">
                                             <span style="display: inline-block; width: 20px; text-align: center; background-color: #e6e6e6; border-radius: 2px; margin-right: 8px; font-size: 12px;">{{ loop.index }}</span>
                                             {{ option.option_text }}
                                             {% if option.is_correct %}
                                             <span style="color: #5FB878; font-weight: bold; margin-left: 8px;">✓ 正确答案</span>
                                             {% endif %}
                                         </div>
                                         {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- 显示评分题的设置 -->
                                {% if question.question_type == 'rating' %}
                                <div style="margin-bottom: 15px;">
                                    <h5 style="color: #666; margin-bottom: 8px;">评分设置：</h5>
                                    <div style="background-color: #fafafa; padding: 10px; border-radius: 4px; color: #333;">
                                        评分范围：1 - {{ question.rating_max or 5 }} 分
                                        {% if question.rating_labels %}
                                        <br>标签：{{ question.rating_labels }}
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- 用户答案 -->
                                {% set answer = answer_dict.get(question.id) %}
                                <div style="background-color: #f0f9ff; padding: 15px; border-radius: 4px; border-left: 4px solid #1E9FFF;">
                                    <h4 style="margin: 0 0 10px 0; color: #333;">用户答案：</h4>
                                    <div class="layui-text" style="line-height: 1.8; color: #333;">
                                        {% if answer %}
                                            {% if question.question_type in ['single_choice', 'multiple_choice'] %}
                                                {% if answer.answer_option_ids %}
                                                    {% set selected_option_ids = answer.get_option_ids() %}
                                                    {% for option_id in selected_option_ids %}
                                                        {% for option in question.options %}
                                                            {% if option.id == option_id|int %}
                                                                <div style="display: inline-block; margin: 2px;">
                                                                    <span style="display: inline-block; background-color: #1E9FFF; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">{{ option.option_text }}</span>
                                                                    {% if option.allow_input and answer.option_custom_inputs and answer.option_custom_inputs.get(option.id|string) %}
                                                                        <span style="display: inline-block; background-color: #f0f0f0; color: #333; padding: 2px 8px; border-radius: 12px; margin-left: 4px; font-size: 12px; border: 1px solid #ddd;">{{ answer.option_custom_inputs.get(option.id|string) }}</span>
                                                                    {% endif %}
                                                                </div>
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% endfor %}
                                                {% else %}
                                                    <span style="color: #999;">未选择</span>
                                                {% endif %}
                                            {% elif question.question_type == 'rating' %}
                                                {% if answer.answer_value %}
                                                    <div style="font-size: 16px;">
                                                        {% for i in range(1, (question.config.rating_max or 5) + 1) %}
                                                            {% if i <= (answer.answer_value | int) %}
                                                                <span style="color: #FFB800;">★</span>
                                                            {% else %}
                                                                <span style="color: #e6e6e6;">☆</span>
                                                            {% endif %}
                                                        {% endfor %}
                                                        <span style="margin-left: 10px; color: #1E9FFF; font-weight: bold;">{{ answer.answer_value }} 分</span>
                                                    </div>
                                                {% else %}
                                                    <span style="color: #999;">未评分</span>
                                                {% endif %}
                                            {% elif question.question_type == 'file' %}
                                                {% if answer.answer_text %}
                                                    <a href="{{ answer.answer_text }}" target="_blank" style="color: #1E9FFF;">
                                                        <i class="layui-icon layui-icon-file"></i> 查看上传文件
                                                    </a>
                                                {% else %}
                                                    <span style="color: #999;">未上传文件</span>
                                                {% endif %}
                                            {% else %}
                                                {% if answer.answer_text %}
                                                    <div style="white-space: pre-wrap;">{{ answer.answer_text | safe }}</div>
                                                {% else %}
                                                    <span style="color: #999;">未填写</span>
                                                {% endif %}
                                            {% endif %}
                                        {% else %}
                                            <span style="color: #999;">未回答</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if response.remark %}
                <div class="layui-card">
                    <div class="layui-card-header">备注信息</div>
                    <div class="layui-card-body">
                        <div class="layui-text">
                            {{ response.remark }}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="layui-col-md4">
                <!-- 问卷信息 -->
                {% if response.questionnaire %}
                <div class="layui-card">
                    <div class="layui-card-header">
                        <span class="layui-icon layui-icon-survey"></span>
                        问卷信息
                    </div>
                    <div class="layui-card-body">
                        <table class="layui-table" lay-skin="nob">
                            <tbody>
                                <tr>
                                    <td width="80" style="background-color: #f8f8f8;"><strong>标题</strong></td>
                                    <td>{{ response.questionnaire.title }}</td>
                                </tr>
                                <tr>
                                    <td style="background-color: #f8f8f8;"><strong>状态</strong></td>
                                    <td>
                                        {% if response.questionnaire.status == 'published' %}
                                            <span class="layui-badge layui-bg-green">已发布</span>
                                        {% elif response.questionnaire.status == 'draft' %}
                                            <span class="layui-badge layui-bg-orange">草稿</span>
                                        {% elif response.questionnaire.status == 'closed' %}
                                            <span class="layui-badge layui-bg-gray">已关闭</span>
                                        {% else %}
                                            <span class="layui-badge">{{ response.questionnaire.status }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% if response.questionnaire.description %}
                                <tr>
                                    <td style="background-color: #f8f8f8;"><strong>描述</strong></td>
                                    <td style="word-break: break-all;">{{ response.questionnaire.description }}</td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <td style="background-color: #f8f8f8;"><strong>匿名</strong></td>
                                    <td>
                                        {% if response.questionnaire.anonymous %}
                                            <span class="layui-badge layui-bg-green">是</span>
                                        {% else %}
                                            <span class="layui-badge layui-bg-orange">否</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td style="background-color: #f8f8f8;"><strong>需要登录</strong></td>
                                    <td>
                                        {% if response.questionnaire.require_login %}
                                            <span class="layui-badge layui-bg-orange">是</span>
                                        {% else %}
                                            <span class="layui-badge layui-bg-green">否</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}

                <!-- 统计信息 -->
                <div class="layui-card">
                    <div class="layui-card-header">
                        <span class="layui-icon layui-icon-chart"></span>
                        统计信息
                    </div>
                    <div class="layui-card-body">
                        <div class="layui-row layui-col-space10">
                            <div class="layui-col-md6">
                                <div style="text-align: center; padding: 10px; background-color: #f8f8f8; border-radius: 4px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #1E9FFF;">{{ answer_dict|length if answer_dict else 0 }}</div>
                                    <div style="color: #666; font-size: 12px;">回答题目数</div>
                                </div>
                            </div>
                            <div class="layui-col-md6">
                                <div style="text-align: center; padding: 10px; background-color: #f8f8f8; border-radius: 4px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #5FB878;">
                                        {% if response.submit_time and response.start_time %}
                                            {{ ((response.submit_time - response.start_time).total_seconds() / 60) | round(1) }}
                                        {% else %}
                                            --
                                        {% endif %}
                                    </div>
                                    <div style="color: #666; font-size: 12px;">填写时长(分钟)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div class="layui-card">
                    <div class="layui-card-header">操作</div>
                    <div class="layui-card-body">
                        <button type="button" class="layui-btn layui-btn-normal layui-btn-fluid" style="margin-top: 10px;" onclick="downloadRecord()">
                            <i class="layui-icon layui-icon-download-circle"></i> 下载记录
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
{% include 'system/common/footer.html' %}
<script>
layui.use(['layer', 'admin'], function(){
    var layer = layui.layer;
    
    // 下载记录功能
    window.downloadRecord = function() {
        var url = MODULE_PATH + 'responses/download/{{ response.id }}';
        window.open(url, '_blank');
    };
});
</script>
</body>
</html>