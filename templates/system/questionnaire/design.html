<!DOCTYPE html>
<html>
  <head>
    <title>问卷设计</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Vue.js 3 -->
    <script src="{{ url_for('static', filename='index/js/vue.global.js') }}"></script>
    <!-- Naive UI -->
    <script src="{{ url_for('static', filename='index/js/naiveui.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='system/questionnaire/css/design.css') }}">
  </head>
  <body>
    <div id="app">
      <n-message-provider>
        <div class="design-container">
          <!-- 问卷基本信息 -->
          <n-card style="margin-bottom: 24px">
            <template #header>
              <n-space align="center">
                <n-icon size="20" color="#18a058">
                  <svg viewBox="0 0 24 24">
                    <path
                      fill="currentColor"
                      d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"
                    />
                  </svg>
                </n-icon>
                <span style="font-size: 18px; font-weight: 500"
                  >[[ questionnaire.title ]]</span
                >
              </n-space>
            </template>
            <n-space vertical>
              <n-text depth="2"
                >[[ questionnaire.description || '暂无描述' ]]</n-text
              >
              <n-space>
                <n-tag type="info" size="small"
                  >类型：[[ questionnaire.type_text ]]</n-tag
                >
                <n-tag type="success" size="small"
                  >状态：[[ questionnaire.status_text ]]</n-tag
                >
              </n-space>
            </n-space>
          </n-card>

          <!-- 问题设计区域 -->
          <n-card>
            <template #header>
              <n-space align="center" justify="space-between">
                <span style="font-size: 16px; font-weight: 500">问题设计</span>
                <n-button type="primary" @click="addQuestion">
                  <template #icon>
                    <n-icon>
                      <svg viewBox="0 0 24 24">
                        <path
                          fill="currentColor"
                          d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"
                        />
                      </svg>
                    </n-icon>
                  </template>
                  添加问题
                </n-button>
              </n-space>
            </template>

            <!-- 问题列表 -->
            <n-space vertical size="large">
              <n-card
                v-for="(question, index) in questions"
                :key="question.id"
                class="question-item"
                hoverable
              >
                <div class="question-header">
                  <div class="question-meta">
                    <span class="drag-handle">⋮⋮</span>
                    <n-tag
                      :type="getQuestionTypeColor(question.question_type)"
                      size="small"
                    >
                      [[ getQuestionTypeName(question.question_type) ]]
                    </n-tag>
                    <n-text strong>问题 [[ index + 1 ]]</n-text>
                    <n-tag v-if="question.is_required" type="error" size="small"
                      >必填</n-tag
                    >
                  </div>
                  <div class="question-actions">
                    <n-button size="small" @click="editQuestion(question.id)">
                      <template #icon>
                        <n-icon>
                          <svg viewBox="0 0 24 24">
                            <path
                              fill="currentColor"
                              d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"
                            />
                          </svg>
                        </n-icon>
                      </template>
                      编辑
                    </n-button>
                    <n-button
                      size="small"
                      type="error"
                      @click="deleteQuestion(question.id)"
                    >
                      <template #icon>
                        <n-icon>
                          <svg viewBox="0 0 24 24">
                            <path
                              fill="currentColor"
                              d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"
                            />
                          </svg>
                        </n-icon>
                      </template>
                      删除
                    </n-button>
                  </div>
                </div>

                <n-space vertical>
                  <n-text strong>[[ question.title ]]</n-text>
                  <n-text v-if="question.description" depth="3"
                    >[[ question.description ]]</n-text
                  >

                  <!-- 选项显示 -->
                  <div
                    v-if="question.options && question.options.length > 0"
                    class="question-options"
                  >
                    <div
                      v-for="(option, optIndex) in question.options"
                      :key="optIndex"
                      :class="['option-item', { correct: option.is_correct }]"
                    >
                      <n-space align="center">
                        <span>[[ String.fromCharCode(65 + optIndex) ]].</span>
                        <span>[[ option.option_text ]]</span>
                        <n-tag
                          v-if="option.is_correct"
                          type="success"
                          size="small"
                          >正确答案</n-tag
                        >
                      </n-space>
                    </div>
                  </div>
                </n-space>
              </n-card>

              <!-- 空状态 -->
              <n-empty
                v-if="questions.length === 0"
                description="暂无问题，点击上方按钮添加问题"
              >
                <template #extra>
                  <n-button @click="addQuestion">添加第一个问题</n-button>
                </template>
              </n-empty>
            </n-space>
          </n-card>
        </div>
      </n-message-provider>

      <!-- 工具栏 -->
      <div class="toolbar">
        <n-button @click="previewQuestionnaire">
          <template #icon>
            <n-icon>
              <svg viewBox="0 0 24 24">
                <path
                  fill="currentColor"
                  d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z"
                />
              </svg>
            </n-icon>
          </template>
          预览
        </n-button>
        <n-button type="success" @click="publishQuestionnaire">
          <template #icon>
            <n-icon>
              <svg viewBox="0 0 24 24">
                <path fill="currentColor" d="M5,4V7H10.5V19H13.5V7H19V4H5Z" />
              </svg>
            </n-icon>
          </template>
          发布问卷
        </n-button>
      </div>
    </div>

    <script>
      const { createApp, ref, reactive, onMounted, computed } = Vue;
      const {
        NCard,
        NSpace,
        NIcon,
        NText,
        NTag,
        NButton,
        NEmpty,
        NMessageProvider,
        createDiscreteApi,
      } = naive;

      const app = createApp({
        delimiters: ["[[", "]]"],
        setup() {
          const { message, dialog } = createDiscreteApi(["message", "dialog"]);

          const questions = ref([]);
          const loading = ref(false);
          const questionnaire = ref({
            id: null,
            title: "",
            description: "",
            type_text: "",
            status_text: "",
          });

          // 问题类型配置
          const questionTypes = {
            single_choice: { name: "单选题", color: "info" },
            multiple_choice: { name: "多选题", color: "success" },
            text: { name: "文本题", color: "default" },
            textarea: { name: "长文本", color: "default" },
            number: { name: "数字题", color: "warning" },
            date: { name: "日期题", color: "warning" },
            rating: { name: "评分题", color: "error" },
          };

          // 获取问题类型名称
          const getQuestionTypeName = (type) => {
            return questionTypes[type]?.name || type;
          };

          // 获取问题类型颜色
          const getQuestionTypeColor = (type) => {
            return questionTypes[type]?.color || "default";
          };

          // 添加问题
          const addQuestion = () => {
            // 使用原生方式打开弹窗，保持与现有系统兼容
            if (window.parent && window.parent.layer) {
              window.parent.layer.open({
                type: 2,
                title: "添加问题",
                area: ["90%", "90%"],
                content: `/system/questionnaire/question/add/${questionnaire.value.id}`,
                end: function () {
                  loadQuestions();
                },
              });
            } else {
              window.open(
                `/system/questionnaire/question/add/${questionnaire.value.id}`,
                "_blank"
              );
            }
          };

          // 编辑问题
          const editQuestion = (questionId) => {
            if (window.parent && window.parent.layer) {
              window.parent.layer.open({
                type: 2,
                title: "编辑问题",
                area: ["90%", "90%"],
                content: "/system/questionnaire/question/edit/" + questionId,
                end: function () {
                  loadQuestions();
                },
              });
            } else {
              window.open(
                "/system/questionnaire/question/edit/" + questionId,
                "_blank"
              );
            }
          };

          // 删除问题
          const deleteQuestion = (questionId) => {
            dialog.warning({
              title: "确认删除",
              content: "确定要删除这个问题吗？",
              positiveText: "确定",
              negativeText: "取消",
              onPositiveClick: async () => {
                try {
                  const response = await fetch(
                    `/system/questionnaire/question/delete/${questionId}`,
                    {
                      method: "DELETE",
                    }
                  );
                  const result = await response.json();

                  if (result.success) {
                    message.success("删除成功");
                    loadQuestions();
                  } else {
                    message.error(result.msg || "删除失败");
                  }
                } catch (error) {
                  message.error("删除失败");
                }
              },
            });
          };

          // 预览问卷
          const previewQuestionnaire = () => {
            if (window.parent && window.parent.layer) {
              window.parent.layer.open({
                type: 2,
                title: "问卷预览",
                area: ["90%", "90%"],
                content: `/system/questionnaire/preview/${questionnaire.value.id}`,
              });
            } else {
              window.open(
                `/system/questionnaire/preview/${questionnaire.value.id}`,
                "_blank"
              );
            }
          };

          // 保存设计
          const saveDesign = () => {
            message.success("设计已保存");
          };

          // 发布问卷
          const publishQuestionnaire = () => {
            dialog.warning({
              title: "确认发布",
              content: "确定要发布这个问卷吗？发布后将无法修改问题结构。",
              positiveText: "确定发布",
              negativeText: "取消",
              onPositiveClick: async () => {
                try {
                  const response = await fetch(
                    `/system/questionnaire/publish/${questionnaire.value.id}`,
                    {
                      method: "POST",
                    }
                  );
                  const result = await response.json();

                  if (result.success) {
                    message.success("发布成功");
                    setTimeout(() => {
                      if (window.parent && window.parent.layer) {
                        window.parent.layer.close(
                          window.parent.layer.getFrameIndex(window.name)
                        );
                        if (window.parent.layui && window.parent.layui.table) {
                          window.parent.layui.table.reload(
                            "questionnaire-table"
                          );
                        }
                      }
                    }, 1000);
                  } else {
                    message.error(result.msg || "发布失败");
                  }
                } catch (error) {
                  message.error("发布失败");
                }
              },
            });
          };

          // 加载问题列表
          const loadQuestions = async () => {
            try {
              loading.value = true;
              const response = await fetch(
                `/system/questionnaire/questions/${questionnaire.value.id}`
              );
              const result = await response.json();

              if (result.success) {
                questions.value = result.data || [];
              }
            } catch (error) {
              console.error("加载问题失败:", error);
            } finally {
              loading.value = false;
            }
          };

          // 初始化问卷数据
          const initQuestionnaire = async () => {
            try {
              // 从URL获取问卷ID
              const urlPath = window.location.pathname;
              const questionnaireId = urlPath.split("/").pop();

              if (questionnaireId) {
                questionnaire.value.id = questionnaireId;

                // 获取问卷基本信息
                const response = await fetch(
                  `/system/questionnaire/detail/${questionnaireId}`
                );
                const result = await response.json();

                if (result.success && result.data) {
                  questionnaire.value = {
                    ...questionnaire.value,
                    ...result.data,
                  };
                }
              }
            } catch (error) {
              console.error("初始化问卷数据失败:", error);
              // 使用默认值
              questionnaire.value = {
                id: 1,
                title: "问卷标题",
                description: "问卷描述",
                type_text: "调查问卷",
                status_text: "草稿",
              };
            }
          };

          // 页面加载时初始化数据
          onMounted(async () => {
            await initQuestionnaire();
            loadQuestions();
          });

          return {
            questions,
            loading,
            questionnaire,
            getQuestionTypeName,
            getQuestionTypeColor,
            addQuestion,
            editQuestion,
            deleteQuestion,
            previewQuestionnaire,
            saveDesign,
            publishQuestionnaire,
          };
        },
      });

      app.use(naive);
      app.mount("#app");
    </script>
  </body>
</html>
