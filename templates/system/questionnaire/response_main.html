<!DOCTYPE html>
<html>
<head>
    <title>问卷填写记录</title>
    {% include 'system/common/header.html' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='system/admin/css/other/user.css') }}"/>
    <script src="{{ url_for('static', filename='system/component/layui/layui.js') }}"></script>
    <script src="{{ url_for('static', filename='system/component/pear/pear.js') }}"></script>
</head>
<body class="pear-container">
{# 查询表单 #}
<div class="layui-card">
    <div class="layui-card-body">
        <form class="layui-form" action="" lay-filter="response-query-form">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">手机号</label>
                    <div class="layui-input-inline">
                        <input type="text" name="phone" placeholder="请输入手机号" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">状态</label>
                    <div class="layui-input-inline">
                        <select name="status" lay-search="">
                            <option value="">全部状态</option>
                            <option value="0">进行中</option>
                            <option value="1">已完成</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">提交时间</label>
                    <div class="layui-input-inline">
                        <input type="text" name="start_date" placeholder="开始日期" class="layui-input" id="start-date">
                    </div>
                    <div class="layui-form-mid">-</div>
                    <div class="layui-input-inline">
                        <input type="text" name="end_date" placeholder="结束日期" class="layui-input" id="end-date">
                    </div>
                </div>
                <div class="layui-inline">
                    <button class="pear-btn pear-btn-md pear-btn-primary" lay-submit lay-filter="response-query">
                        <i class="layui-icon layui-icon-search"></i>
                        查询
                    </button>
                    <button type="reset" class="pear-btn pear-btn-md">
                        <i class="layui-icon layui-icon-refresh"></i>
                        重置
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

{# 填写记录表格 #}
<div class="layui-card">
    <div class="layui-card-body">
        <table id="response-table" lay-filter="response-table"></table>
    </div>
</div>

{# 表格工具栏 #}
<script type="text/html" id="response-toolbar">
    {% if authorize("system:questionnaire:export") %}
        <button class="pear-btn pear-btn-success pear-btn-md" lay-event="export">
            <i class="pear-icon pear-icon-download"></i>
            导出记录
        </button>
    {% endif %}
    <button class="pear-btn pear-btn-success pear-btn-md" lay-event="refresh">
        <i class="layui-icon layui-icon-refresh"></i>
        刷新
    </button>
</script>

{# 行操作按钮 #}
<script type="text/html" id="response-bar">
    <button class="pear-btn pear-btn-info pear-btn-sm" lay-event="detail">
        <i class="pear-icon pear-icon-eye"></i> 详情
    </button>
    {% raw %}
        {{# if(d.status == 1){ }}
            <button class="pear-btn pear-btn-primary pear-btn-sm" lay-event="download">
                <i class="pear-icon pear-icon-download"></i> 下载
            </button>
        {{# } }}
    {% endraw %}
</script>

{# 状态显示模板 #}
{% raw %}
<script type="text/html" id="response-status">
    {{# if(d.status == 0){ }}
        <span class="layui-badge layui-bg-orange">进行中</span>
    {{# } else if(d.status == 1){ }}
        <span class="layui-badge layui-bg-green">已完成</span>
    {{# } }}
</script>
{% endraw %}

{# 手机号显示模板 #}
{% raw %}
<script type="text/html" id="phone-display">
    {{# if(d.phone){ }}
        {{ d.phone }}
    {{# } else { }}
        <span class="layui-text-muted">未填写</span>
    {{# } }}
</script>
{% endraw %}

{# 姓名显示模板 #}
{% raw %}
<script type="text/html" id="name-display">
    {{# if(d.name){ }}
        {{ d.name }}
    {{# } else { }}
        <span class="layui-text-muted">未填写</span>
    {{# } }}
</script>
{% endraw %}

{# 用时显示模板 #}
{% raw %}
<script type="text/html" id="duration-display">
    {{# if(d.duration){ }}
        {{ d.duration }}
    {{# } else { }}
        <span class="layui-text-muted">-</span>
    {{# } }}
</script>
{% endraw %}

<script>
layui.use(['table', 'form', 'layer', 'laydate'], function () {
    let table = layui.table;
    let form = layui.form;
    let layer = layui.layer;
    let laydate = layui.laydate;

    // 初始化日期选择器
    laydate.render({
        elem: '#start-date',
        type: 'date'
    });
    
    laydate.render({
        elem: '#end-date',
        type: 'date'
    });

    // 获取问卷ID（从URL中获取）
    let questionnaireId = window.location.pathname.split('/').pop();

    // 初始化表格
    let cols = [
        [
            {type: 'checkbox', fixed: 'left'},
            {field: 'id', title: 'ID', width: 80, sort: true},
            {field: 'phone', title: '手机号', width: 150, templet: '#phone-display'},
            {field: 'name', title: '姓名', width: 120, templet: '#name-display'},
            {field: 'ip_address', title: 'IP地址', width: 140},
            {field: 'user_agent', title: '设备信息', width: 200, hide: true},
            {field: 'status', title: '状态', width: 100, templet: '#response-status'},
            {field: 'start_time', title: '开始时间', width: 160, sort: true},
            {field: 'submit_time', title: '提交时间', width: 160, sort: true},
            {field: 'duration', title: '用时', width: 100, templet: '#duration-display'},
            {title: '操作', toolbar: '#response-bar', width: 180, fixed: 'right'}
        ]
    ];

    table.render({
        elem: '#response-table',
        url: '/system/questionnaire/response_data/' + questionnaireId,
        toolbar: '#response-toolbar',
        defaultToolbar: ['filter', 'exports', 'print'],
        cols: cols,
        page: true,
        parseData: function (res) {
            return {
                "code": res.code,
                "msg": res.msg,
                "count": res.count,
                "data": res.data
            };
        },
        request: {
            pageName: 'page',
            limitName: 'limit'
        }
    });

    // 工具栏事件
    table.on('toolbar(response-table)', function (obj) {
        if (obj.event === 'export') {
            // 获取当前查询条件
            let queryData = {};
            $('.layui-form input, .layui-form select').each(function() {
                let name = $(this).attr('name');
                let value = $(this).val();
                if (name && value) {
                    queryData[name] = value;
                }
            });
            
            // 构建导出URL
            let exportUrl = '/system/questionnaire/response_export/' + questionnaireId;
            let params = new URLSearchParams(queryData);
            if (params.toString()) {
                exportUrl += '?' + params.toString();
            }
            
            // 下载文件
            window.open(exportUrl, '_blank');
        } else if (obj.event === 'refresh') {
            table.reload('response-table');
        }
    });

    // 行操作事件
    table.on('tool(response-table)', function (obj) {
        if (obj.event === 'detail') {
            // 查看详情
            layer.open({
                type: 2,
                title: '填写详情 - ID: ' + obj.data.id,
                shade: 0.1,
                area: ['90%', '90%'],
                content: '/system/questionnaire/response_detail/' + obj.data.id
            });
        } else if (obj.event === 'download') {
            // 下载单个记录
            window.open('/system/questionnaire/response_download/' + obj.data.id, '_blank');
        }
    });

    // 查询表单提交
    form.on('submit(response-query)', function (data) {
        table.reload('response-table', {
            where: data.field,
            page: {
                curr: 1
            }
        });
        return false;
    });
});
</script>
</body>
</html>